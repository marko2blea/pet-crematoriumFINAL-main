// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ================================================================
// MODELOS PRINCIPALES
// ================================================================

model Usuario {
  id_usuario       Int       @id @default(autoincrement())
  nombre           String?   @db.VarChar(100)
  apellido_paterno String?   @db.VarChar(100)
  apellido_materno String?   @db.VarChar(100)
  fecha_nacimiento DateTime? @db.Date
  correo           String?   @unique @db.VarChar(255)
  contrase_a       String?   @map("contrase√±a") @db.VarChar(255)
  telefono         Int?
  fecha_registro   DateTime? @db.Date
  region           String?   @db.VarChar(100)
  comuna           String?   @db.VarChar(100)
  direccion        String?   @db.VarChar(255)
  id_rol           Int?

  rol Rol? @relation(fields: [id_rol], references: [id_rol], onDelete: NoAction, onUpdate: NoAction)
  mascotas     Mascota[]
  pedidos      Pedido[]
  valoraciones Valoracion[]

  reset_token           String?   @unique @db.VarChar(255)
  reset_token_expires DateTime?
  
  @@map("usuario")
}

model Rol {
  id_rol          Int       @id @default(autoincrement())
  nombre_rol      String?   @db.VarChar(100)
  descripcion_rol String?   @db.VarChar(255)
  usuario         Usuario[]
  
  @@map("rol")
}

model Producto {
  cod_producto    Int      @id @default(autoincrement())
  nombre_producto String?  @unique @db.VarChar(255)
  stock_actual    Int?
  precio_unitario Decimal? @db.Decimal(10, 2)
  disponible      Boolean?
  tipo_producto   String?  @db.VarChar(100)
  id_proveedor    Int?

  descripcion String? @db.Text
  imagen_url  String? @db.VarChar(500)

  proveedor Proveedor? @relation(fields: [id_proveedor], references: [id_proveedor], onDelete: NoAction, onUpdate: NoAction)

  valoraciones    Valoracion[]
  detalles_pedido DetallePedido[]
  
  detalle_reservas Detalle_Reserva[] @relation("ProductToDetalleReserva") 
  
  @@map("producto")
}

// ================================================================
// LOGICA DE NEGOCIO
// ================================================================

model Pedido {
  id_pedido       Int             @id @default(autoincrement())
  id_usuario      Int
  id_pago         Int?            @unique
  fecha_pedido    DateTime        @default(now())
  precio_total    Decimal         @db.Decimal(10, 2)
  estado_pedido   String          @default("Pendiente")
  es_reserva      Boolean

  usuario         Usuario         @relation(fields: [id_usuario], references: [id_usuario])
  pago            Pago?           @relation(fields: [id_pago], references: [id_pago])
  reserva         Reserva?        @relation("PedidoToReserva") 
  envio           Envio?
  detalles_pedido DetallePedido[]

  @@map("pedido")
}

model DetallePedido {
  id_detalle_pedido Int      @id @default(autoincrement())
  id_pedido         Int
  cod_producto      Int
  cantidad          Int
  precio_unitario   Decimal  @db.Decimal(10, 2)

  pedido   Pedido   @relation(fields: [id_pedido], references: [id_pedido], onDelete: Cascade)
  producto Producto @relation(fields: [cod_producto], references: [cod_producto])

  @@map("detalle_pedido")
}

model Pago {
  id_pago       Int         @id @default(autoincrement())
  nombre_metodo String?     @db.VarChar(100)
  fecha_pago    DateTime    @default(now())
  monto         Decimal     @db.Decimal(10, 2)
  estado        String      @default("Pendiente")
  
  pedido Pedido?
  
  id_metodo Int? 
  metodo_pago Metodo_Pago? @relation(fields: [id_metodo], references: [id_metodo], onDelete: NoAction, onUpdate: NoAction)

  @@map("pago")
}

model Reserva {
  id_reserva         Int              @id @default(autoincrement())
  id_pedido          Int              @unique
  cod_trazabilidad   String?          @unique @db.Char(9)
  fecha_reservada    DateTime?
  hora_reservada     DateTime?
  estado_reserva     String           @default("Pendiente")
  precio_total       Decimal          @db.Decimal(10, 2)
  region             String?          @db.VarChar(100)
  comuna             String?          @db.VarChar(100)
  direccion          String?          @db.VarChar(255)

  pedido             Pedido           @relation("PedidoToReserva", fields: [id_pedido], references: [id_pedido], onDelete: Cascade)
  
  id_detalle_reserva Int? 
  detalle_reserva    Detalle_Reserva? @relation("ReservaToDetalle", fields: [id_detalle_reserva], references: [id_detalle_reserva])

  @@map("reserva")
}

model Envio {
  id_envio        Int    @id @default(autoincrement())
  id_pedido       Int    @unique
  region_envio    String
  comuna_envio    String
  direccion_envio String
  estado_envio    String @default("Pendiente")

  pedido Pedido @relation(fields: [id_pedido], references: [id_pedido], onDelete: Cascade)

  @@map("envio")
}

// ================================================================
// MODELOS SECUNDARIOS Y FALTANTES
// ================================================================

model Metodo_Pago {
  id_metodo                   Int       @id @default(autoincrement())
  nombre_metodo               String?   @db.VarChar(100)
  n_recibo_efectivo           Int?
  url_comprobante_transferencia String? @db.VarChar(255)
  rut_emisor                  String?   @db.VarChar(20)
  banco_emisor                String?   @db.VarChar(100)
  tipo_cuenta                 String?   @db.VarChar(50)
  num_cuenta                  String?   @db.VarChar(50)
  num_transaccion_externa     String?   @db.VarChar(100)
  pago                        Pago[]
  
  @@map("metodo_pago")
}

model Detalle_Reserva {
  id_detalle_reserva Int       @id @default(autoincrement())
  nombre_servicio    String?   @db.VarChar(255)
  precio_servicio    Decimal?  @db.Decimal(10, 2)
  tipo_servicio      String?   @db.VarChar(100)
  desc_servicio      String?   @db.VarChar(500)
  cantidad           Int?
  precio_total       Decimal?  @db.Decimal(10, 2)
  cod_producto       Int?

  producto           Producto? @relation("ProductToDetalleReserva", fields: [cod_producto], references: [cod_producto], onDelete: NoAction, onUpdate: NoAction) 
  reserva            Reserva[] @relation("ReservaToDetalle")

  @@map("detalle_reserva") 
}

model Mascota {
  id_mascota            Int       @id @default(autoincrement())
  nombre_mascota        String?   @db.VarChar(100)
  peso                  Decimal?  @db.Decimal(5, 2)
  edad                  Int?
  diagnostico_sanitario String?   @db.VarChar(500)
  notas_manipulacion    String?   @db.VarChar(500)
  id_especie            Int?
  id_usuario            Int?

  usuario Usuario? @relation(fields: [id_usuario], references: [id_usuario], onDelete: SetNull)
  especie Especie? @relation(fields: [id_especie], references: [id_especie], onDelete: NoAction, onUpdate: NoAction)
  
  @@map("mascota")
}

model Especie {
  id_especie     Int      @id @default(autoincrement())
  tipo_mascota   String?
  nombre_especie String?
  raza           String?
  mascota        Mascota[]
}

model Proveedor {
  id_proveedor Int        @id @default(autoincrement())
  proveedor    String?    @db.VarChar(255)
  contacto     Int?
  region       String?    @db.VarChar(100)
  comuna       String?    @db.VarChar(100)
  direccion    String?    @db.VarChar(255)
  disponible   Boolean?
  producto     Producto[]
  
  @@map("proveedor")
}

model Valoracion {
  id_valoracion  Int      @id @default(autoincrement())
  rating         Int
  comentario     String?  @db.Text
  fecha_creacion DateTime @default(now())
  id_producto    Int
  id_usuario     Int

  producto Producto @relation(fields: [id_producto], references: [cod_producto], onDelete: Cascade)
  usuario  Usuario  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@unique([id_producto, id_usuario])
  @@map("valoracion")
}

model PageContent {
  page_key String  @id @unique
  title    String  @db.Text
  subtitle String? @db.Text
  
  @@map("page_content")
}

model Memorial {
  id_memorial Int       @id @default(autoincrement())
  nombre      String    @db.VarChar(100)
  raza        String?   @db.VarChar(100)
  fecha       DateTime  @db.Date
  dedicatoria String?   @db.VarChar(255)
  creado_en   DateTime  @default(now())
  
  @@map("memorial")
}

model Instalacion {
  id_instalacion Int       @id @default(autoincrement())
  title          String    @unique @db.VarChar(255)
  body           String    @db.Text
  features       String[]
  orden          Int       @default(autoincrement())
  creado_en      DateTime  @default(now())
  imagen_url     String?   @db.VarChar(500)
  
  @@map("instalacion")
}

model AboutBlock {
  id_block   Int      @id @default(autoincrement())
  title      String   @db.VarChar(255)
  body       String   @db.Text
  items      String[]
  orden      Int      @default(autoincrement())
  creado_en  DateTime @default(now())
  imagen_url String?  @db.VarChar(500)
  
  @@map("about_block")
}